##############START update_std_txt ###############	

@std.route('/update_std_txt', methods=['POST'])
@login_required
def update_std_txt(txt_type):
    
    #FROM https://stackoverflow.com/questions/43811779/use-many-submit-buttons-in-the-same-form
        
    std_txt = Std_general_txt.query.filter(Std_general_txt.selected==True).first()
       
    if std_txt == None:
        flash("Please select a student and a txt to match  first ")
        return redirect(url_for('students.edit_student_destinations'))		
    
      
    general_txt_sts_name = "sts"+ str(std_txt.general_txt_id)
    ##print( "request.form[general_txt_sts_name]", request.form[general_txt_sts_name])
    
    general_txt_date_name = "due_date" + str(std_txt.general_txt_id)
    ##print( "request.form[general_txt_date_name]", request.form[general_txt_date_name])
    
    if txt_type == 'todo':
        general_txt_who_name = "who"+ str(std_txt.general_txt_id)
        ##print( "request.form[general_txt_who_name]", request.form[general_txt_who_name])
        
    selected_general_txt_status = Status.query.filter(Status.id==request.form[general_txt_sts_name]).first()
    if selected_general_txt_status != None:
        std_txt.status_id = selected_general_txt_status.id  
    general_txt_due_date = request.form[general_txt_date_name]                
    if general_txt_due_date != None:
        std_txt.due_date = general_txt_due_date
        
    if txt_type == 'todo':
        who = Accupation.query.filter(Accupation.id==request.form.get(general_txt_who_name)).first()
        if who != None:
            std_txt.acc_id = who.id
           
    std_txt.selected = False
        
    #print("std txt: ", std_txt)
    #print("")
    
    #print("std_txt.who_id", std_txt.acc_id)
    #print("")
    #print("std_txt.status_id", std_txt.status_id)
    #print("")
    #print("std_txt.due_date", date.today(), std_txt.due_date)
    #print("")
    #print("std_txt.selected ", std_txt.selected)
    #print("")
    
    db.session.commit() 

    return  redirect(url_for('students.edit_student_destinations')) 


@std.route('/update_std_txt2', methods=['GET', 'POST'])
@login_required
def update_std_txt2():
    
    std = Student.query.filter(Student.selected==True).first()
        
    if( int(request.form['txt_type_form_button_name']) % 3 == 0 ):    # case of destination    
        selected_dst_id = request.form['txt_type_form_button_name']
        selected_dst_id = int(int(selected_dst_id)/3)         
         
        dst = Destination.query.filter(Destination.id == selected_dst_id).first()           
        std_gt = attach_gt_to_std(std.id, dst.id)
     
        std_gt = std_general_txt_select2(std.id, selected_dst_id)
                
        return update_std_txt(txt_type='dst')
         
    elif( int(request.form['txt_type_form_button_name']) % 3 == 1 ):    # case of goal    
        selected_goal_id = request.form['txt_type_form_button_name']
        selected_goal_id = int(int(selected_goal_id)/3)
         
        goal = Goal.query.filter(Goal.id == selected_goal_id).first()            
        std_gt = attach_gt_to_std(std.id, goal.id)
             
        std_gt = std_general_txt_select2(std.id, selected_goal_id) 

        return update_std_txt(txt_type='goal')
                       
    elif ( int(request.form['txt_type_form_button_name']) % 3 == 2 ):     # case of todo   
        selected_todo_id = request.form['txt_type_form_button_name']
        selected_todo_id = int((int(selected_todo_id)-1)/3)

        todo = Todo.query.filter(Todo.id == selected_todo_id).first()           
        std_gt = attach_gt_to_std(std.id, todo.id)
            
        std_gt = std_general_txt_select2(std.id, selected_todo_id) 
                
        return update_std_txt(txt_type='todo')
                   
    return update_std_txt()
    
##############END update_std_txt ###############	

########## START attach_gt_to_std #############################

@std.route('/attach_gt_to_std/<int:std_id>/<int:gt_id>', methods=['GET', 'POST'])
def attach_gt_to_std(std_id, gt_id):

    std_gt = Std_general_txt.query.filter(Std_general_txt.student_id==std_id).filter(Std_general_txt.general_txt_id==gt_id).first()
    if std_gt == None:
        std_gt = Std_general_txt(std_id, gt_id)
        
        std_gt.due_date =date.today()
        
        sts = Status.query.filter(Status.body=='default').first()
        std_gt.status_id = sts.id 
     
        who = Accupation.query.filter(Accupation.body=='default').first()
        std_gt.acc_id = who.id 

        gt = General_txt.query.filter(General_txt.id==gt_id).first()        
        std = Student.query.filter(Student.id==std_id).first()
        if std_gt not in gt.students:
            gt.students.append(std_gt)
        if std_gt not in std.general_txts:
            std.general_txts.append(std_gt)
        
    db.session.commit()
    return std_gt    

########## START attach_gt_to_std #############################

######### END  student's genearal txt #################################
